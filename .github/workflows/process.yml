# git ffmpeg-commit && git ffmpeg-push; gh ffmpeg-wrun process.yml -F yaml=@"$title/job.yaml" -f title="$title" -f try=true -f t=10

name: process
run-name: ${{ inputs.title }}
on:
  workflow_dispatch:
    inputs:
      title:
        required: true
      yaml:
        required: true
      input-root:
        default: blomp:chess-videos
      output-root:
        default: koofr:done
      t:
        default: 5
      try:
        type: boolean

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      data: ${{ steps.matrix.outputs.data }}
    steps:
      - name: Define matrix
        id: matrix
        run: |
          echo "${{ inputs.title }}"
          yq "$(base64 -d <<< ${{ vars.JOB_JQ }})" << "EOF" | tee y
          ${{ inputs.yaml }}EOF
          { printf "data="; yq 'sort_by(.duration)|reverse' -oj -I0 y; } >> $GITHUB_OUTPUT

  process:
    name: ${{ matrix.file }}
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.data) }}
    env:
      ifile: ${{ matrix.file }}

    steps:
      - name: Sudo tar
        run: sudo chown root /usr/bin/tar && sudo chmod u+s /usr/bin/tar

      - uses: actions/cache/restore@v4
        with:
          key: bin
          path: |
            /home/runner/.local/bin
            /lib/x86_64-linux-gnu/libfuse.*

      - name: Download
        run: |
          rclone copyto "${{ inputs.input-root }}/${{ inputs.title }}/${{ matrix.file }}" "$ifile" --stats-one-line -v &

          name=${ifile%.*}
          cat << EOF >> "$GITHUB_ENV"
          name=$name
          ofile=out/${{ inputs.try && 'begin2' || inputs.title }}/$name.mkv
          EOF

          mkdir -p out/{info,logs,images2,images_end2,begin2,end2,reports,"${{ inputs.title }}"}/"$(dirname "$ifile")"
          echo ${{ vars.PRESET }} | base64 -d > preset
          wait

      - name: Try process
        if: inputs.try
        run: |
          echo "aom-params=cpu-used=8:cq-level=48" >> preset
          cat preset
          echo "${{ matrix.ops }}"

          FFREPORT=file=ffmpeg.log:level=48 \
          ffmpeg -hide_banner -nostdin -nostats -benchmark -i "$ifile" \
          ${{ matrix.ops }} -t ${{ inputs.t }} -fpre preset "$ofile"

      - name: Process
        if: ${{ ! inputs.try }}
        run: |
          tree
          cat preset
          echo "${{ matrix.ops }}"

          FFREPORT=file=ffmpeg.log:level=32 \
          ffmpeg -hide_banner -nostdin -nostats -benchmark \
          -i "$ifile" ${{ matrix.ops }} -fpre preset "$ofile"

          ffmpeg -v 24 -i "$ofile" -t ${{ inputs.t }} -c copy "out/begin2/$name.mkv" &
          ffmpeg -v 24 -sseof -${{ inputs.t }} -i "$ofile" "out/end2/$name.mkv" &

          mkvmerge "$ofile" -o "$ofile"~
          mv "$ofile"~ "$ofile"
          mv preset out/info
          wait

      - name: Report
        run: |
          sed 2,4d ffmpeg.log > "out/logs/$name.log"

          ${{ inputs.try }} || {
            ffmpeg -v 24 -i "out/begin2/$name.mkv" -frames 1 -update 1 "out/images2/$name.png"
            ffmpeg -v 24 -i "out/end2/$name.mkv" -frames 1 -update 1 "out/images_end2/$name.png"
          }
          {
            ffprobe -v 24 -show_streams -show_format -of json "$ifile" | jq -rj '[
              (.streams[0] | .width, .height, .r_frame_rate),
              (.format | .duration, .size, .bit_rate), "*", ""] | @tsv'
            ffprobe -v 24 -show_streams -show_format -of json "$ofile" | jq -r '[
              (.streams[0] | .width, .height, .r_frame_rate),
              (.format | .duration, .size, .bit_rate,
              (.filename | split("/")[-1] | @sh) )] | @tsv'
          } | tee "out/reports/$name.txt"

          cat << "EOF" > out/job.yaml
          ${{ inputs.yaml }}EOF

      - name: Upload
        run: rclone copy out "${{ inputs.output-root }}/${{ inputs.title }}" -v --no-update-modtime --retries 10
